#!/bin/bash

function usage() {
  echo "body - show body of file"
  echo
  echo "version 0.1.0"
  echo "[option]"
  echo "  -n lines: show lines from center"
  echo "  -h lines: assign head lines"
  echo "  -t lines: assign tail lines"
}


function get_body_without_head_and_tail_pipe() {
  if [[ ! -z "$hd" ]] && [[ ! -z "$tl" ]];then
    text="$(cat - | tail -n +`expr $hd + 1` | head -n -"$tl")"
  elif [[ -z "$hd" ]] && [[ ! -z "$tl" ]]; then
    text="$(cat - | tail -n +"$DEFAULT_REMOVE_LINE" | head -n -"$tl")"
  elif [[ ! -z "$hd" ]] && [[ -z "$tl" ]]; then
    text="$(cat - | tail -n +`expr $hd + 1` | head -n -"$DEFAULT_REMOVE_LINE")"
  else
    # default: remove each 10 lines 
    text="$(cat - | tail -n +"$DEFAULT_REMOVE_LINE" | head -n -"$DEFAULT_REMOVE_LINE")"
  fi
  echo "$text"
}

function get_body_without_head_and_tail_arg() {
  if [[ ! -z "$hd" ]] && [[ ! -z "$tl" ]];then
    text="$(cat $1 | tail -n +`expr $hd + 1` | head -n -"$tl")"
  elif [[ -z "$hd" ]] && [[ ! -z "$tl" ]]; then
    text="$(cat $1 | tail -n +"$DEFAULT_REMOVE_LINE" | head -n -"$tl")"
  elif [[ ! -z "$hd" ]] && [[ -z "$tl" ]]; then
    text="$(cat $1 | tail -n +`expr $hd + 1` | head -n -"$DEFAULT_REMOVE_LINE")"
  else
    # default: remove each 10 lines 
    text="$(cat $1 | tail -n +"$DEFAULT_REMOVE_LINE" | head -n -"$DEFAULT_REMOVE_LINE")"
  fi
  echo "$text"
}

function get_body_from_center_arg() {
  line_count="$(cat $1 | grep -c '')"
  center_line="$(expr $line_count / 2)"
  range=$DEFAULT_REMOVE_LINE
  if [[ ! -z "$line" ]];then
    range="$(expr $line / 2)"
    # even lines
    if [[ "$(expr $line_count % 2 )" -eq 0 ]]; then
      bf="$(expr $center_line - $range)"
      af="$(expr $center_line + $range)"
      text="$(cat $1 | head -"$af" | tail -`expr $af - $bf + 1`)"
    # odd lines
    elif [[ "$(expr $line_count % 2 )" -eq 1 ]]; then
      bf="$(expr $center_line - $range)"
      af="$(expr $center_line + $range + 1)"
      text="$(cat $1 | head -n "$af" | tail -n `expr $af - $bf`)"
    fi
  else
    bf="$(expr $center_line - $range)"
    af="$(expr $center_line + $range)"
    text="$(cat $1 | head -"$af" | tail -`expr $af - $bf + 1`)"
  fi
  echo "$text"
}

function get_body_from_center_pipe() {
  line_count="$(echo "$1" | grep -c '')"
  center_line="$(expr $line_count / 2)"
  range=$DEFAULT_REMOVE_LINE
  if [[ ! -z "$line" ]];then
    range="$(expr $line / 2)"
    # even lines
    if [[ "$(expr $line_count % 2 )" -eq 0 ]]; then
      bf="$(expr $center_line - $range)"
      af="$(expr $center_line + $range)"
      text="$(echo "$1" | head -"$af" | tail -`expr $af - $bf + 1`)"
    # odd lines
    elif [[ "$(expr $line_count % 2 )" -eq 1 ]]; then
      bf="$(expr $center_line - $range)"
      af="$(expr $center_line + $range + 1)"
      text="$(echo "$1" | head -n "$af" | tail -n `expr $af - $bf`)"
    fi
  else
    bf="$(expr $center_line - $range)"
    af="$(expr $center_line + $range)"
    text="$(echo "$1" | head -"$af" | tail -`expr $af - $bf + 1`)"
  fi
  echo "$text"
}

MODE=0
while getopts "h:t:n:" opts
do
  case $opts in
    h )
      hd="$OPTARG"
      MODE=1
      ;;
    t )
      tl="$OPTARG"
      MODE=1
      ;;
    n )
      line="$OPTARG"
      MODE=2
      ;;
    \?)
      usage
      exit 1
      ;;
  esac
done

shift $((OPTIND - 1))

DEFAULT_REMOVE_LINE=10

# main

case "$MODE" in
  0 )
    usage
    exit
    ;;
  1 )
    if [ -p /dev/stdin ]; then
      get_body_without_head_and_tail_pipe "$(cat -)"
    elif [ $# -eq 1 ]; then
      get_body_without_head_and_tail_arg "$1"
    else
      usage
    fi
    ;;
  2 )
    if [ -p /dev/stdin ]; then
      get_body_from_center_pipe "$(cat -)"
    elif [ $# -eq 1 ]; then
      get_body_from_center_arg "$1"
    else
      usage
    fi
    ;;
esac


